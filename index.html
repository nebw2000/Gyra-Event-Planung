<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Event Manager</title>
<style>
body { font-family: Arial; margin:0; background:#f4f6f8; }
header { background:#0f5f57; color:white; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; }
header button { background:#ffffff33; border:none; padding:8px 14px; color:white; border-radius:6px; cursor:pointer; }
.container { max-width:1000px; margin:auto; padding:20px; }
h2 { color:#0f5f57; }
label { display:block; margin:5px 0 2px; font-weight:bold; }
input, select, textarea, button { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px; box-sizing:border-box; }
button { border:none; background:#0f5f57; color:white; cursor:pointer; font-size:16px; }
#toast { position:fixed; top:15px; left:50%; transform:translateX(-50%); background:#0f5f57; padding:10px 14px; color:white; border-radius:8px; display:none; }
.event-list { margin-top:20px; }
.event-item { background:white; padding:10px; border-radius:6px; margin-bottom:10px; box-shadow:0 0 5px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
.event-item button { width:auto; margin-left:5px; }
#newEventForm { background:white; padding:20px; border-radius:8px; margin-top:20px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
#newEventForm .row { display:flex; flex-wrap:wrap; gap:20px; }
#newEventForm .col { flex:1 1 200px; min-width:150px; }
textarea { resize:none; }
</style>
</head>
<body>

<div class="container" id="loginScreen">
    <h2>Login</h2>
    <label>Benutzer</label>
    <select id="userType">
        <option value="admin">Admin</option>
        <option value="teacher">Lehrer*innen</option>
    </select>
    <label>Passwort</label>
    <input type="password" id="loginPassword">
    <button id="loginBtn">Login</button>
</div>

<div class="container" id="mainScreen" style="display:none;">
    <header>
        <h2>Event Manager</h2>
        <button id="logoutBtn">Logout</button>
    </header>

    <button id="newEventBtn">Event hinzufügen</button>

    <div id="newEventForm" style="display:none;">
        <h2>Neues Event erstellen / bearbeiten</h2>

        <div class="row">
            <div class="col"><label>Name</label><input id="name" type="text"></div>
            <div class="col"><label>Leiter</label><input id="leader" type="text"></div>
            <div class="col"><label>Typ</label>
                <select id="type">
                    <option>Probe</option>
                    <option>Konzert</option>
                    <option>Theater</option>
                    <option>Konferenz</option>
                    <option>Präsentation</option>
                    <option>Rede</option>
                    <option>Andere</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col"><label>Ort</label>
                <select id="location"><option>Atrium</option><option>Forum</option></select>
            </div>
            <div class="col"><label>Mikrofone (gesamt)</label>
                <select id="mic"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>mehr</option></select>
            </div>
            <div class="col"><label>Gesangs-Mikros</label>
                <select id="vocMic"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>mehr</option></select>
            </div>
        </div>

        <div class="row">
            <div class="col"><label><input type="checkbox" id="podium"> Rednerpult benötigt</label></div>
            <div class="col"><label>Beamer</label>
                <select id="beamer"><option>Nein</option><option>Ja Bühne</option><option>Ja Wand</option><option>Ja beide</option></select>
            </div>
            <div class="col"><label>Keyboards</label>
                <select id="keyboard"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
            </div>
            <div class="col"><label>Gitarren</label>
                <select id="guitar"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
            </div>
        </div>

        <div class="row">
            <div class="col"><label>Datum</label><input id="date" type="date"></div>
            <div class="col"><label>Uhrzeit</label><input id="time" type="time"></div>
        </div>

        <div class="row">
            <div class="col"><label>Skript (optional)</label><input id="script" type="file"></div>
            <div class="col"><label>Kommentar (optional)</label><textarea id="comments" rows="3"></textarea></div>
        </div>

        <button id="saveBtn">Speichern</button>
        <button id="cancelEditBtn" style="background:#777; margin-left:10px;">Abbrechen</button>
    </div>

    <h2>Alle Events</h2>
    <div class="event-list" id="eventList"></div>
</div>

<div id="toast"></div>

<script type="module">
import { db } from "./firebase-config.js";
import { ref, push, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/9.8.3/firebase-database.js";

const loginScreen = document.getElementById("loginScreen");
const mainScreen = document.getElementById("mainScreen");
const userType = document.getElementById("userType");
const loginPassword = document.getElementById("loginPassword");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const newEventBtn = document.getElementById("newEventBtn");
const newEventForm = document.getElementById("newEventForm");
const saveBtn = document.getElementById("saveBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const eventList = document.getElementById("eventList");
const toast = document.getElementById("toast");

let editKey = null;

function showToast(msg){
    toast.textContent=msg;
    toast.style.display="block";
    setTimeout(()=>{toast.style.display="none";},3000);
}

loginBtn.addEventListener("click", ()=>{
    const type = userType.value;
    const pw = loginPassword.value;
    if((type=="admin" && pw=="2309") || (type=="teacher" && pw=="event")){
        loginScreen.style.display="none";
        mainScreen.style.display="block";
        loadEvents();
    } else { showToast("Falsches Passwort"); }
});

logoutBtn.addEventListener("click", ()=>{
    loginScreen.style.display="block";
    mainScreen.style.display="none";
});

newEventBtn.addEventListener("click", ()=>{
    newEventForm.style.display="block";
    editKey=null;
    saveBtn.textContent="Speichern";
});

cancelEditBtn.addEventListener("click", ()=>{
    newEventForm.style.display="none";
    editKey=null;
});

saveBtn.addEventListener("click", async ()=>{
    const eventData = {
        name: document.getElementById("name").value,
        leader: document.getElementById("leader").value,
        type: document.getElementById("type").value,
        location: document.getElementById("location").value,
        mic: document.getElementById("mic").value,
        vocMic: document.getElementById("vocMic").value,
        podium: document.getElementById("podium").checked?"x":"",
        beamer: document.getElementById("beamer").value,
        keyboard: document.getElementById("keyboard").value,
        guitar: document.getElementById("guitar").value,
        date: document.getElementById("date").value,
        time: document.getElementById("time").value,
        comments: document.getElementById("comments").value || "",
        script: document.getElementById("script").files[0]?document.getElementById("script").files[0].name:""
    };
    if(!eventData.name || !eventData.leader || !eventData.date || !eventData.time){
        showToast("Bitte Pflichtfelder ausfüllen");
        return;
    }

    if(editKey){
        await update(ref(db,"events/"+editKey), eventData);
        showToast("Event aktualisiert");
    } else {
        const newRef = push(ref(db,"events"));
        await set(newRef,eventData);
        showToast("Event gespeichert");
    }

    newEventForm.style.display="none";
    editKey=null;
    clearForm();
});

function clearForm(){
    ["name","leader","type","location","mic","vocMic","podium","beamer","keyboard","guitar","date","time","comments","script"].forEach(id=>{
        const el=document.getElementById(id);
        if(el.type==="checkbox") el.checked=false;
        else if(el.tagName==="INPUT") el.value="";
        else if(el.tagName==="SELECT") el.selectedIndex=0;
        else if(el.tagName==="TEXTAREA") el.value="";
    });
}

function loadEvents(){
    onValue(ref(db,"events"), snapshot=>{
        const data = snapshot.val()||{};
        eventList.innerHTML="";
        for(let key in data){
            const e = data[key];
            const div = document.createElement("div");
            div.className="event-item";
            div.innerHTML=`<div><strong>${e.name}</strong> (${e.type})<br>${e.date} ${e.time} - ${e.location}</div>`;
            
            const detailBtn = document.createElement("button");
            detailBtn.textContent="Details";
            detailBtn.onclick=()=>{ showDetails(e); };
            
            const editBtn = document.createElement("button");
            editBtn.textContent="Bearbeiten";
            editBtn.onclick=()=>{ editEvent(key,e); };
            
            const delBtn = document.createElement("button");
            delBtn.textContent="Löschen";
            delBtn.onclick=()=>{ if(confirm("Event löschen?")) remove(ref(db,"events/"+key)); };
            
            div.appendChild(detailBtn);
            div.appendChild(editBtn);
            div.appendChild(delBtn);
            eventList.appendChild(div);
        }
    });
}

function showDetails(e){
    let msg = `Name: ${e.name}\nLeiter: ${e.leader}\nTyp: ${e.type}\nOrt: ${e.location}\nMikrofone: ${e.mic}\nGesangs-Mikros: ${e.vocMic}\nRednerpult: ${e.podium}\nBeamer: ${e.beamer}\nKeyboards: ${e.keyboard}\nGitarren: ${e.guitar}\nDatum: ${e.date}\nUhrzeit: ${e.time}\nSkript: ${e.script}\nKommentar: ${e.comments}`;
    alert(msg);
}

function editEvent(key,e){
    editKey=key;
    document.getElementById("name").value=e.name;
    document.getElementById("leader").value=e.leader;
    document.getElementById("type").value=e.type;
    document.getElementById("location").value=e.location;
    document.getElementById("mic").value=e.mic;
    document.getElementById("vocMic").value=e.vocMic;
    document.getElementById("podium").checked=e.podium=="x";
    document.getElementById("beamer").value=e.beamer;
    document.getElementById("keyboard").value=e.keyboard;
    document.getElementById("guitar").value=e.guitar;
    document.getElementById("date").value=e.date;
    document.getElementById("time").value=e.time;
    document.getElementById("comments").value=e.comments;
    saveBtn.textContent="Aktualisieren";
    newEventForm.style.display="block";
}
</script>
</body>
</html>
